<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†å“¡ - å“¡å·¥å·¥æ™‚ç´€éŒ„</title>
</head>

<body>
    <div id="userInfo" style="text-align: right; margin: 10px;"></div>

    <h2>ğŸ› ï¸ ç®¡ç†å“¡ - æ‰€æœ‰å“¡å·¥å·¥æ™‚ç´€éŒ„</h2>

    <h3>ğŸ” æŸ¥è©¢æ¢ä»¶</h3>
    <label>ä½¿ç”¨è€…ï¼š</label>
    <select id="userSelect">
        <option value="">-- å…¨éƒ¨ --</option>
    </select>
    <br><br>
    <label>èµ·å§‹æ—¥ï¼š</label>
    <input type="date" id="startDate">
    <label>çµæŸæ—¥ï¼š</label>
    <input type="date" id="endDate">
    <button onclick="loadLogs()">æŸ¥è©¢</button>

    <hr />
    <table border="1" cellpadding="6">
        <thead>
            <tr>
                <th>ä½¿ç”¨è€…</th>
                <th>æ—¥æœŸ</th>
                <th>èµ·</th>
                <th>è¨–</th>
                <th>é¡å‹</th>
                <th>å…§å®¹</th>
                <th>åŠ ç­</th>
            </tr>
        </thead>
        <tbody id="logTable"></tbody>
    </table>

    <script>
        const token = localStorage.getItem("token");
        const username = localStorage.getItem("username");

        if (!token || !username) {
            alert("è«‹å…ˆç™»å…¥");
            window.location.href = "/login.html";
        } else {
            document.getElementById("userInfo").innerText = `ğŸ‘‘ ç®¡ç†è€…ï¼š${username}`;
        }

        // âœ… æ™‚é–“æ ¼å¼è½‰æ›å™¨ï¼ˆè½‰æˆ HH:mm é¡¯ç¤ºï¼‰
        function formatTime(timeStr) {
            if (!timeStr) return "";
            const [hour, minute] = timeStr.split(":");
            return `${hour}:${minute}`;
        }

        // âœ… è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…é¸å–®
        async function loadUsers() {
            const res = await fetch("/api/users/all", {
                headers: { Authorization: "Bearer " + token }
            });
            const users = await res.json();
            const select = document.getElementById("userSelect");
            users.forEach(user => {
                const opt = document.createElement("option");
                opt.value = user.Id;
                opt.textContent = `${user.Username} (${user.Role})`;
                select.appendChild(opt);
            });
        }

        // âœ… æŸ¥è©¢å·¥æ™‚è³‡æ–™
        async function loadLogs(init = false) {
            console.log("âœ… æŸ¥è©¢æŒ‰éˆ•è¢«æŒ‰äº†");

            const tbody = document.getElementById("logTable");
            tbody.innerHTML = `<tr><td colspan="7">â³ è¼‰å…¥ä¸­...</td></tr>`;

            let url = "/api/workLogs/admin/all";
            if (!init) {
                const startDate = document.getElementById("startDate").value;
                const endDate = document.getElementById("endDate").value;
                const userId = Number(document.getElementById("userSelect").value);

                const query = new URLSearchParams();
                if (startDate) query.append("startDate", startDate);
                if (endDate) query.append("endDate", endDate);
                if (userId) query.append("userId", userId);
                console.log("ğŸ” æŸ¥è©¢åƒæ•¸", { userId, startDate, endDate });
                console.log("ğŸ”§ select DOMå€¼ = ", document.getElementById("userSelect").value);
                url += "?" + query.toString();
            }

            try {
                const res = await fetch(url, {
                    method: "GET",
                    headers: { Authorization: "Bearer " + token },
                    cache: "no-store"
                });

                const data = await res.json();

                if (!res.ok) {
                    return alert("âŒ ç„¡æ³•å–å¾—ç´€éŒ„ï¼š" + (data.message || "æœªçŸ¥éŒ¯èª¤"));
                }

                tbody.innerHTML = "";

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7">âš ï¸ ç„¡ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</td></tr>`;
                    return;
                }

                data.forEach(log => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${log.Username}</td>
                        <td>${log.WorkDate.slice(0, 10)}</td>
                        <td>${formatTime(log.StartTime)}</td>
                        <td>${formatTime(log.EndTime)}</td>
                        <td>${log.WorkType}</td>
                        <td>${log.Description}</td>
                        <td>${log.IsOvertime ? "âœ…" : ""}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (err) {
                alert("âŒ ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
                console.error(err);
            }
        }

        // âœ… é é¢åˆå§‹åŒ–
        loadUsers();
        loadLogs(true);
    </script>
</body>

</html>