<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>管理員 - 員工工時紀錄</title>
</head>

<body>
    <div id="userInfo" style="text-align: right; margin: 10px;"></div>

    <h2>🛠️ 管理員 - 所有員工工時紀錄</h2>

    <h3>🔍 查詢條件</h3>
    <label>使用者：</label>
    <select id="userSelect">
        <option value="">-- 全部 --</option>
    </select>
    <br><br>
    <label>起始日：</label>
    <input type="date" id="startDate">
    <label>結束日：</label>
    <input type="date" id="endDate">
    <button onclick="loadLogs()">查詢</button>

    <hr />
    <table border="1" cellpadding="6">
        <thead>
            <tr>
                <th>使用者</th>
                <th>日期</th>
                <th>起</th>
                <th>訖</th>
                <th>類型</th>
                <th>內容</th>
                <th>加班</th>
            </tr>
        </thead>
        <tbody id="logTable"></tbody>
    </table>

    <script>
        const token = localStorage.getItem("token");
        const username = localStorage.getItem("username");

        if (!token || !username) {
            alert("請先登入");
            window.location.href = "/login.html";
        } else {
            document.getElementById("userInfo").innerText = `👑 管理者：${username}`;
        }

        // ✅ 載入所有使用者清單（供下拉查詢用）
        async function loadUsers() {
            const res = await fetch("/api/users/all", {
                headers: { Authorization: "Bearer " + token }
            });
            const users = await res.json();
            const select = document.getElementById("userSelect");
            users.forEach(user => {
                const opt = document.createElement("option");
                opt.value = user.Id;
                opt.textContent = `${user.Username} (${user.Role})`;
                select.appendChild(opt);
            });
        }

        // ✅ 查詢工時紀錄（支援使用者與起訖日）
        async function loadLogs() {
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;
            const userId = document.getElementById("userSelect").value;

            const query = new URLSearchParams();
            if (startDate) query.append("startDate", startDate);
            if (endDate) query.append("endDate", endDate);
            if (userId) query.append("userId", userId);

            try {
                const res = await fetch("/api/workLogs/admin/all?" + query.toString(), {
                    headers: { Authorization: "Bearer " + token }
                });

                const data = await res.json();

                if (!res.ok) {
                    return alert("❌ 無法取得紀錄：" + (data.message || "未知錯誤"));
                }

                const tbody = document.getElementById("logTable");
                tbody.innerHTML = "";

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7">⚠️ 無符合條件的紀錄</td></tr>`;
                    return;
                }

                data.forEach(log => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
            <td>${log.Username}</td>
            <td>${log.WorkDate.slice(0, 10)}</td>
            <td>${log.StartTime}</td>
            <td>${log.EndTime}</td>
            <td>${log.WorkType}</td>
            <td>${log.Description}</td>
            <td>${log.IsOvertime ? "✅" : ""}</td>
          `;
                    tbody.appendChild(tr);
                });

            } catch (err) {
                alert("❌ 伺服器錯誤，請稍後再試");
                console.error(err);
            }
        }

        // 頁面初始載入
        loadUsers();
        loadLogs();
    </script>
</body>

</html>