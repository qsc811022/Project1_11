<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>管理員 - 員工工時紀錄</title>
</head>

<body>
    <div id="userInfo" style="text-align: right; margin: 10px;"></div>

    <h2>🛠️ 管理員 - 所有員工工時紀錄</h2>

    <h3>🔍 查詢條件</h3>
    <label>使用者：</label>
    <select id="userSelect">
        <option value="">-- 全部 --</option>
    </select>
    <br><br>
    <label>起始日：</label>
    <input type="date" id="startDate">
    <label>結束日：</label>
    <input type="date" id="endDate">
    <button onclick="loadLogs()">查詢</button>

    <hr />
    <table border="1" cellpadding="6">
        <thead>
            <tr>
                <th>使用者</th>
                <th>日期</th>
                <th>起</th>
                <th>訖</th>
                <th>類型</th>
                <th>內容</th>
                <th>加班</th>
            </tr>
        </thead>
        <tbody id="logTable"></tbody>
    </table>

    <script>
        const token = localStorage.getItem("token");
        const username = localStorage.getItem("username");

        if (!token || !username) {
            alert("請先登入");
            window.location.href = "/login.html";
        } else {
            document.getElementById("userInfo").innerText = `👑 管理者：${username}`;
        }

        // ✅ 時間格式轉換器（轉成 HH:mm 顯示）
        function formatTime(timeStr) {
            if (!timeStr) return "";
            const [hour, minute] = timeStr.split(":");
            return `${hour}:${minute}`;
        }

        // ✅ 載入所有使用者選單
        async function loadUsers() {
            const res = await fetch("/api/users/all", {
                headers: { Authorization: "Bearer " + token }
            });
            const users = await res.json();
            const select = document.getElementById("userSelect");
            users.forEach(user => {
                const opt = document.createElement("option");
                opt.value = user.Id;
                opt.textContent = `${user.Username} (${user.Role})`;
                select.appendChild(opt);
            });
        }

        // ✅ 查詢工時資料
        async function loadLogs(init = false) {
            console.log("✅ 查詢按鈕被按了");

            const tbody = document.getElementById("logTable");
            tbody.innerHTML = `<tr><td colspan="7">⏳ 載入中...</td></tr>`;

            let url = "/api/workLogs/admin/all";
            if (!init) {
                const startDate = document.getElementById("startDate").value;
                const endDate = document.getElementById("endDate").value;
                const userId = Number(document.getElementById("userSelect").value);

                const query = new URLSearchParams();
                if (startDate) query.append("startDate", startDate);
                if (endDate) query.append("endDate", endDate);
                if (userId) query.append("userId", userId);
                console.log("🔍 查詢參數", { userId, startDate, endDate });
                console.log("🔧 select DOM值 = ", document.getElementById("userSelect").value);
                url += "?" + query.toString();
            }

            try {
                const res = await fetch(url, {
                    method: "GET",
                    headers: { Authorization: "Bearer " + token },
                    cache: "no-store"
                });

                const data = await res.json();

                if (!res.ok) {
                    return alert("❌ 無法取得紀錄：" + (data.message || "未知錯誤"));
                }

                tbody.innerHTML = "";

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7">⚠️ 無符合條件的紀錄</td></tr>`;
                    return;
                }

                data.forEach(log => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${log.Username}</td>
                        <td>${log.WorkDate.slice(0, 10)}</td>
                        <td>${formatTime(log.StartTime)}</td>
                        <td>${formatTime(log.EndTime)}</td>
                        <td>${log.WorkType}</td>
                        <td>${log.Description}</td>
                        <td>${log.IsOvertime ? "✅" : ""}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (err) {
                alert("❌ 伺服器錯誤，請稍後再試");
                console.error(err);
            }
        }

        // ✅ 頁面初始化
        loadUsers();
        loadLogs(true);
    </script>
</body>

</html>